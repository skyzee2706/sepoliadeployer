<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVM Immutable Token Deployer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script>tailwind.config = { theme: { extend: { fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] } } } }</script>
    <style>
        body { background-color: #0a0a0a; color: #e5e5e5; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; background: #171717; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #404040; border-radius: 4px; }
        input:focus, select:focus { outline: none; border-color: #3b82f6; ring: 2px; ring-color: #3b82f6; }
    </style>
</head>
<body class="min-h-screen flex flex-col relative">

    <!-- WALLET MODAL -->
    <div id="walletModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/90 hidden opacity-0 transition-opacity duration-200">
        <div class="bg-neutral-900 border border-neutral-800 rounded-xl w-full max-w-sm p-5 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-white">Connect Wallet</h3>
                <button onclick="toggleModal(false)" class="text-neutral-500 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <div class="space-y-3">
                <button onclick="connectProvider('metamask')" class="w-full flex items-center gap-3 p-4 bg-neutral-800 hover:bg-neutral-700 rounded-lg border border-neutral-700 transition-all font-bold text-sm">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/3/36/MetaMask_Fox.svg" class="w-6 h-6"> MetaMask
                </button>
                <button onclick="connectProvider('okx')" class="w-full flex items-center gap-3 p-4 bg-neutral-800 hover:bg-neutral-700 rounded-lg border border-neutral-700 transition-all font-bold text-sm">
                    <div class="w-6 h-6 bg-white rounded-full text-black flex items-center justify-center font-black text-[9px]">OKX</div> OKX Wallet
                </button>
            </div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="h-16 border-b border-neutral-800 bg-black/50 backdrop-blur sticky top-0 z-40 px-4 md:px-8 flex items-center justify-between">
        <div class="flex items-center gap-2 font-bold text-lg tracking-tight">
            <div class="bg-blue-600 p-1.5 rounded"><i data-lucide="blocks" class="text-white w-4 h-4"></i></div>
            <span>EVM<span class="text-blue-500">Deployer</span></span>
        </div>
        <div class="flex items-center gap-3">
            <div class="relative hidden md:block">
                <select id="networkSelect" onchange="handleNetworkChange()" class="appearance-none bg-neutral-900 border border-neutral-700 text-xs font-bold rounded-lg pl-3 pr-8 py-2 text-neutral-300 cursor-pointer w-40">
                    <optgroup label="Testnets (Free)">
                        <option value="0xaa36a7" selected>Sepolia ETH</option>
                        <option value="0x14a34">Base Sepolia</option>
                    </optgroup>
                    <optgroup label="Mainnets (Real)">
                        <option value="0x1">Ethereum</option>
                        <option value="0x38">BNB Chain</option>
                        <option value="0x2105">Base</option>
                        <option value="0xa4b1">Arbitrum</option>
                        <option value="0xa">Optimism</option>
                        <option value="0x89">Polygon</option>
                        <option value="0xa86a">Avalanche</option>
                    </optgroup>
                </select>
                <i data-lucide="chevron-down" class="absolute right-2.5 top-2.5 w-3 h-3 text-neutral-500 pointer-events-none"></i>
            </div>
            <button id="btnConnect" onclick="toggleModal(true)" class="bg-white text-black hover:bg-neutral-200 px-4 py-2 rounded-lg text-xs font-bold transition-all">
                Connect Wallet
            </button>
        </div>
    </header>

    <!-- CONTENT -->
    <main class="flex-1 max-w-6xl mx-auto w-full p-4 md:p-8 grid md:grid-cols-12 gap-8">
        
        <!-- FORM -->
        <div class="md:col-span-7 space-y-6">
            <div class="bg-neutral-900 border border-neutral-800 rounded-2xl p-6 md:p-8 shadow-xl">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-white">Create Token</h2>
                        <p class="text-xs text-neutral-500 mt-1">Standard ERC-20 • Immutable • Fixed Supply</p>
                    </div>
                    <span id="networkBadge" class="px-2 py-1 rounded border border-neutral-700 bg-neutral-800 text-[10px] text-neutral-400 font-mono">Not Connected</span>
                </div>

                <div class="space-y-5">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] uppercase font-bold text-neutral-500 mb-1">Token Name</label>
                            <input id="inputName" class="w-full bg-black border border-neutral-800 rounded-lg p-3 text-sm text-white transition-colors" placeholder="e.g. My Token">
                        </div>
                        <div>
                            <label class="block text-[10px] uppercase font-bold text-neutral-500 mb-1">Symbol / Ticker</label>
                            <input id="inputSymbol" class="w-full bg-black border border-neutral-800 rounded-lg p-3 text-sm text-white transition-colors" placeholder="e.g. TKN">
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] uppercase font-bold text-neutral-500 mb-1">Total Supply</label>
                        <div class="relative">
                            <input id="inputSupply" type="number" value="1000000" class="w-full bg-black border border-neutral-800 rounded-lg p-3 text-sm text-white font-mono transition-colors">
                            <span class="absolute right-3 top-3 text-xs text-neutral-600 font-bold">TOKENS</span>
                        </div>
                    </div>

                    <button id="btnDeploy" onclick="deployToken()" disabled class="w-full py-3.5 rounded-lg font-bold text-sm bg-neutral-800 text-neutral-600 cursor-not-allowed mt-2 transition-all flex justify-center items-center gap-2">
                        Connect Wallet First
                    </button>
                </div>
            </div>
        </div>

        <!-- LOGS -->
        <div class="md:col-span-5 flex flex-col gap-4 h-full">
            <!-- Success Box -->
            <div id="successCard" class="hidden bg-green-500/10 border border-green-500/20 rounded-xl p-5 animate-in fade-in slide-in-from-bottom-2">
                <div class="flex items-center gap-3 mb-3">
                    <div class="bg-green-500 p-1.5 rounded-full text-white"><i data-lucide="check" class="w-4 h-4"></i></div>
                    <h3 class="font-bold text-green-400 text-sm">Deploy Successful</h3>
                </div>
                <div class="bg-black/40 rounded border border-green-500/10 p-3 flex justify-between items-center mb-3">
                    <code id="deployedAddress" class="text-green-300 font-mono text-xs truncate">0x...</code>
                    <button onclick="copyAddress()" class="text-neutral-400 hover:text-white"><i data-lucide="copy" class="w-3 h-3"></i></button>
                </div>
                <a id="etherscanLink" href="#" target="_blank" class="block text-center bg-green-600 hover:bg-green-500 text-white py-2 rounded-lg text-xs font-bold transition-colors">View on Explorer</a>
            </div>

            <!-- Console -->
            <div class="bg-neutral-900 border border-neutral-800 rounded-xl flex-1 flex flex-col overflow-hidden min-h-[300px]">
                <div class="p-3 border-b border-neutral-800 bg-black/20 flex items-center gap-2">
                    <i data-lucide="terminal" class="w-3 h-3 text-blue-500"></i>
                    <span class="text-[10px] font-bold text-neutral-400 uppercase">Deployment Log</span>
                </div>
                <div id="logsArea" class="flex-1 p-3 font-mono text-[10px] overflow-y-auto space-y-1.5 bg-black">
                    <div class="text-neutral-600 text-center mt-10">Waiting for action...</div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // --- NETWORK CONFIGURATION ---
        const NETWORKS = {
            "0xaa36a7": { name: "Sepolia", explorer: "https://sepolia.etherscan.io", rpc: ["https://rpc.sepolia.org"] },
            "0x14a34": { name: "Base Sepolia", explorer: "https://sepolia.basescan.org", rpc: ["https://sepolia.base.org"] },
            "0x1": { name: "Ethereum", explorer: "https://etherscan.io", rpc: ["https://eth.llamarpc.com"] },
            "0x38": { name: "BNB Chain", explorer: "https://bscscan.com", rpc: ["https://bsc-dataseed.binance.org/"] },
            "0x2105": { name: "Base", explorer: "https://basescan.org", rpc: ["https://mainnet.base.org"] },
            "0xa4b1": { name: "Arbitrum", explorer: "https://arbiscan.io", rpc: ["https://arb1.arbitrum.io/rpc"] },
            "0xa": { name: "Optimism", explorer: "https://optimistic.etherscan.io", rpc: ["https://mainnet.optimism.io"] },
            "0x89": { name: "Polygon", explorer: "https://polygonscan.com", rpc: ["https://polygon-rpc.com"] },
            "0xa86a": { name: "Avalanche", explorer: "https://snowtrace.io", rpc: ["https://api.avax.network/ext/bc/C/rpc"] }
        };

        let provider, signer, userAddress, currentChainId = "0xaa36a7";

        // --- CONTRACT ARTIFACTS (The Critical Fix) ---
        
        // 1. ABI (Must match constructor inputs)
        const ABI = [
            "constructor(string name, string symbol, uint256 initialSupply)",
            "function name() view returns (string)",
            "function symbol() view returns (string)",
            "function totalSupply() view returns (uint256)",
            "function balanceOf(address) view returns (uint256)",
            "function transfer(address to, uint256 value) returns (bool)"
        ];

        // 2. BYTECODE (Compiled Standard ERC20 - Solidity 0.8.17)
        // WARNING: This is a LONG string. Copy it completely.
        const BYTECODE = "";

        // --- UI FUNCTIONS ---
        function addLog(msg, type='info') {
            const area = document.getElementById('logsArea');
            if(area.innerText.includes('Waiting for action')) area.innerHTML = '';
            const div = document.createElement('div');
            const color = type==='error'?'text-red-400':(type==='success'?'text-green-400':'text-neutral-300');
            const time = new Date().toLocaleTimeString([], {hour12:false, hour:'2-digit', minute:'2-digit', second:'2-digit'});
            div.innerHTML = `<span class="text-neutral-600 mr-2">[${time}]</span><span class="${color}">${msg}</span>`;
            area.appendChild(div);
            area.scrollTop = area.scrollHeight;
        }

        function toggleModal(s) {
            const m = document.getElementById('walletModal');
            s ? m.classList.remove('hidden') : m.classList.add('hidden');
            if(s) setTimeout(()=>m.classList.remove('opacity-0'),10);
            else setTimeout(()=>m.classList.add('opacity-0'),200);
        }

        async function connectProvider(t) {
            toggleModal(false);
            try {
                const raw = t==='okx' ? window.okxwallet : window.ethereum;
                if(!raw) throw new Error(`${t} Not Found`);
                
                provider = new ethers.BrowserProvider(raw);
                const acc = await provider.send("eth_requestAccounts", []);
                signer = await provider.getSigner();
                userAddress = acc[0];

                document.getElementById('btnConnect').innerText = `${userAddress.substring(0,6)}...`;
                document.getElementById('btnDeploy').disabled = false;
                document.getElementById('btnDeploy').innerHTML = `DEPLOY TOKEN <i data-lucide="rocket" class="ml-2 w-4 h-4"></i>`;
                document.getElementById('btnDeploy').className = "w-full py-3.5 rounded-lg font-bold text-sm bg-blue-600 text-white hover:bg-blue-500 transition-all flex justify-center items-center shadow-lg shadow-blue-900/20";
                
                addLog("Wallet Connected", "success");
                
                // Sync Network
                const net = await provider.getNetwork();
                const cid = "0x" + net.chainId.toString(16);
                if(NETWORKS[cid]) {
                    document.getElementById('networkSelect').value = cid;
                    updateNetworkBadge(cid);
                } else {
                    handleNetworkChange();
                }
            } catch(e) { addLog(e.message, "error"); }
        }

        function updateNetworkBadge(cid) {
            const net = NETWORKS[cid];
            const badge = document.getElementById('networkBadge');
            badge.innerText = net ? net.name : "Unknown";
            badge.className = `px-2 py-1 rounded border text-[10px] font-mono ${net && net.name.includes('Testnet') ? 'bg-green-900/20 border-green-900/50 text-green-400' : 'bg-blue-900/20 border-blue-900/50 text-blue-400'}`;
            currentChainId = cid;
        }

        async function handleNetworkChange() {
            const target = document.getElementById('networkSelect').value;
            updateNetworkBadge(target);
            if(!provider) return;
            
            try {
                await provider.send("wallet_switchEthereumChain", [{ chainId: target }]);
                addLog(`Switched to ${NETWORKS[target].name}`);
            } catch(e) {
                if(e.code === 4902) {
                    const net = NETWORKS[target];
                    try {
                        await provider.send("wallet_addEthereumChain", [{
                            chainId: target, chainName: net.name, rpcUrls: net.rpc,
                            nativeCurrency: {name:"ETH", symbol:"ETH", decimals:18},
                            blockExplorerUrls: [net.explorer]
                        }]);
                    } catch(err) { addLog("Failed to add network", "error"); }
                }
            }
        }

        // --- DEPLOY LOGIC ---
        async function deployToken() {
            const name = document.getElementById('inputName').value;
            const symbol = document.getElementById('inputSymbol').value;
            const supply = document.getElementById('inputSupply').value;

            if(!name || !symbol || !supply) return addLog("Please fill all fields", "error");

            const btn = document.getElementById('btnDeploy');
            btn.disabled = true;
            btn.innerText = "Deploying...";

            try {
                addLog(`Initializing ${name} (${symbol})...`);
                const factory = new ethers.ContractFactory(ABI, BYTECODE, signer);
                const supplyWei = ethers.parseUnits(supply, 18);

                // GAS FIX: Manual Limit to prevent "estimateGas" failures on some nodes
                const options = { gasLimit: 3000000 };
                
                const contract = await factory.deploy(name, symbol, supplyWei, options);
                
                addLog(`Tx Sent: ${contract.deploymentTransaction().hash}`, "warning");
                addLog("Waiting for confirmation...");

                await contract.waitForDeployment();
                
                const address = contract.target;
                document.getElementById('deployedAddress').innerText = address;
                document.getElementById('etherscanLink').href = `${NETWORKS[currentChainId].explorer}/address/${address}`;
                document.getElementById('successCard').classList.remove('hidden');
                
                addLog(`✅ SUCCESS! Contract: ${address}`, "success");
                
                // Auto Watch
                try {
                    await window.ethereum.request({
                        method: 'wallet_watchAsset',
                        params: { type: 'ERC20', options: { address, symbol, decimals: 18 } },
                    });
                } catch(e){}

            } catch(e) {
                console.error(e);
                // Catch specific Revert errors
                if(e.code === 'CALL_EXCEPTION') {
                    addLog("Deploy Failed: Contract Reverted. Try increasing Gas Limit manually in wallet.", "error");
                } else {
                    addLog("Error: " + (e.reason || e.message), "error");
                }
            } finally {
                btn.disabled = false;
                btn.innerHTML = `DEPLOY TOKEN <i data-lucide="rocket" class="ml-2 w-4 h-4"></i>`;
            }
        }

        function copyAddress() {
            navigator.clipboard.writeText(document.getElementById('deployedAddress').innerText);
            addLog("Address copied", "info");
        }

        lucide.createIcons();
    </script>
</body>
</html>


